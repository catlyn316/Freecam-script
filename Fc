-- Roblox å¹³æ¿ Freecam è…³æœ¬
-- é©ç”¨æ–¼è§¸æ§è¢å¹•è¨­å‚™

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local ContextActionService = game:GetService("ContextActionService")

local player = Players.LocalPlayer
local camera = workspace.CurrentCamera
local character = player.Character or player.CharacterAdded:Wait()

-- Freecam ç‹€æ…‹
local freecamEnabled = false
local clickTpEnabled = false
local isMinimized = false
local cameraCFrame = camera.CFrame
local moveSpeed = 1.2
local baseSpeed = 1.2  -- åŸºç¤ç§»å‹•é€Ÿåº¦
local baseVerticalSpeed = 0.5  -- åŸºç¤å‚ç›´é€Ÿåº¦
local speedMultiplier = 1  -- é€Ÿåº¦å€æ•¸
local verticalSpeed = 0.5
local rotationSpeed = 0.015

-- è§¸æ§æ§åˆ¶è®Šé‡
local touchControls = {}
local moveTouch = nil
local lookTouch = nil
local speedTouch = nil

-- å‰µå»ºè§¸æ§æ§åˆ¶ GUI
local function createTouchGUI()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "FreecamTouchControls"
    screenGui.ResetOnSpawn = false
    screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    screenGui.Parent = player.PlayerGui
    
    -- å·¦å´ç§»å‹•æ–æ¡¿å€åŸŸï¼ˆæ›´å¤§ç¯„åœï¼‰
    local moveFrame = Instance.new("Frame")
    moveFrame.Name = "MoveFrame"
    moveFrame.Size = UDim2.new(0, 300, 0, 300)
    moveFrame.Position = UDim2.new(0, 10, 1, -310)
    moveFrame.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    moveFrame.BackgroundTransparency = 0.8
    moveFrame.BorderSizePixel = 0
    moveFrame.Parent = screenGui
    
    local moveCorner = Instance.new("UICorner")
    moveCorner.CornerRadius = UDim.new(0, 150)
    moveCorner.Parent = moveFrame
    
    local moveLabel = Instance.new("TextLabel")
    moveLabel.Size = UDim2.new(1, 0, 1, 0)
    moveLabel.BackgroundTransparency = 1
    moveLabel.Text = "ç§»å‹•"
    moveLabel.TextColor3 = Color3.new(1, 1, 1)
    moveLabel.TextSize = 28
    moveLabel.Font = Enum.Font.GothamBold
    moveLabel.Parent = moveFrame
    
    -- å³å´è¦–è§’æ–æ¡¿å€åŸŸï¼ˆæ›´å¤§ç¯„åœï¼‰
    local lookFrame = Instance.new("Frame")
    lookFrame.Name = "LookFrame"
    lookFrame.Size = UDim2.new(0, 300, 0, 300)
    lookFrame.Position = UDim2.new(1, -310, 1, -310)
    lookFrame.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    lookFrame.BackgroundTransparency = 0.8
    lookFrame.BorderSizePixel = 0
    lookFrame.Parent = screenGui
    
    local lookCorner = Instance.new("UICorner")
    lookCorner.CornerRadius = UDim.new(0, 150)
    lookCorner.Parent = lookFrame
    
    local lookLabel = Instance.new("TextLabel")
    lookLabel.Size = UDim2.new(1, 0, 1, 0)
    lookLabel.BackgroundTransparency = 1
    lookLabel.Text = "è¦–è§’"
    lookLabel.TextColor3 = Color3.new(1, 1, 1)
    lookLabel.TextSize = 28
    lookLabel.Font = Enum.Font.GothamBold
    lookLabel.Parent = lookFrame
    
    -- é€Ÿåº¦æ§åˆ¶æŒ‰éˆ•ï¼ˆä¸Šä¸‹èª¿æ•´é«˜åº¦ï¼‰
    local speedUpBtn = Instance.new("TextButton")
    speedUpBtn.Name = "SpeedUpBtn"
    speedUpBtn.Size = UDim2.new(0, 80, 0, 80)
    speedUpBtn.Position = UDim2.new(0.5, -40, 0, 20)
    speedUpBtn.BackgroundColor3 = Color3.fromRGB(70, 130, 70)
    speedUpBtn.BackgroundTransparency = 0.3
    speedUpBtn.Text = "â†‘"
    speedUpBtn.TextColor3 = Color3.new(1, 1, 1)
    speedUpBtn.TextSize = 36
    speedUpBtn.Font = Enum.Font.GothamBold
    speedUpBtn.Parent = screenGui
    
    local upCorner = Instance.new("UICorner")
    upCorner.CornerRadius = UDim.new(0, 40)
    upCorner.Parent = speedUpBtn
    
    local speedDownBtn = Instance.new("TextButton")
    speedDownBtn.Name = "SpeedDownBtn"
    speedDownBtn.Size = UDim2.new(0, 80, 0, 80)
    speedDownBtn.Position = UDim2.new(0.5, -40, 0, 110)
    speedDownBtn.BackgroundColor3 = Color3.fromRGB(180, 70, 70)
    speedDownBtn.BackgroundTransparency = 0.3
    speedDownBtn.Text = "â†“"
    speedDownBtn.TextColor3 = Color3.new(1, 1, 1)
    speedDownBtn.TextSize = 36
    speedDownBtn.Font = Enum.Font.GothamBold
    speedDownBtn.Parent = screenGui
    
    local downCorner = Instance.new("UICorner")
    downCorner.CornerRadius = UDim.new(0, 40)
    downCorner.Parent = speedDownBtn
    
    -- åˆ‡æ›æŒ‰éˆ•
    local toggleBtn = Instance.new("TextButton")
    toggleBtn.Name = "ToggleBtn"
    toggleBtn.Size = UDim2.new(0, 120, 0, 50)
    toggleBtn.Position = UDim2.new(0.5, -70, 1, -200)
    toggleBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 255)
    toggleBtn.BackgroundTransparency = 0.3
    toggleBtn.Text = "é–‹å•Ÿ Freecam"
    toggleBtn.TextColor3 = Color3.new(1, 1, 1)
    toggleBtn.TextSize = 18
    toggleBtn.Font = Enum.Font.GothamBold
    toggleBtn.Active = false
    toggleBtn.Draggable = false
    toggleBtn.Parent = screenGui
    
    local toggleCorner = Instance.new("UICorner")
    toggleCorner.CornerRadius = UDim.new(0, 10)
    toggleCorner.Parent = toggleBtn
    
    -- ç¸®å°æŒ‰éˆ•ï¼ˆç¨ç«‹å…ƒç´ ï¼Œä¸æ˜¯ toggleBtn çš„å­å…ƒç´ ï¼‰
    local minimizeBtn = Instance.new("TextButton")
    minimizeBtn.Name = "MinimizeBtn"
    minimizeBtn.Size = UDim2.new(0, 50, 0, 50)
    minimizeBtn.Position = UDim2.new(0.5, 60, 1, -200)
    minimizeBtn.AnchorPoint = Vector2.new(0, 0)
    minimizeBtn.BackgroundColor3 = Color3.fromRGB(120, 120, 120)
    minimizeBtn.BackgroundTransparency = 0.3
    minimizeBtn.Text = "âˆ’"
    minimizeBtn.TextColor3 = Color3.new(1, 1, 1)
    minimizeBtn.TextSize = 32
    minimizeBtn.Font = Enum.Font.GothamBold
    minimizeBtn.Active = true
    minimizeBtn.Draggable = true
    minimizeBtn.Parent = screenGui
    
    local minimizeCorner = Instance.new("UICorner")
    minimizeCorner.CornerRadius = UDim.new(0, 10)
    minimizeCorner.Parent = minimizeBtn
    
    -- ClickTP æŒ‰éˆ•
    local clickTpBtn = Instance.new("TextButton")
    clickTpBtn.Name = "ClickTpBtn"
    clickTpBtn.Size = UDim2.new(0, 120, 0, 50)
    clickTpBtn.Position = UDim2.new(0, 0, 0, 60)
    clickTpBtn.BackgroundColor3 = Color3.fromRGB(255, 165, 0)
    clickTpBtn.BackgroundTransparency = 0.3
    clickTpBtn.Text = "ClickTP: é—œ"
    clickTpBtn.TextColor3 = Color3.new(1, 1, 1)
    clickTpBtn.TextSize = 18
    clickTpBtn.Font = Enum.Font.GothamBold
    clickTpBtn.Parent = toggleBtn
    
    local clickTpCorner = Instance.new("UICorner")
    clickTpCorner.CornerRadius = UDim.new(0, 10)
    clickTpCorner.Parent = clickTpBtn
    
    -- é—œé–‰æŒ‰éˆ•ï¼ˆç§»åˆ° ClickTP æ—é‚Šï¼‰
    local closeBtn = Instance.new("TextButton")
    closeBtn.Name = "CloseBtn"
    closeBtn.Size = UDim2.new(0, 50, 0, 50)
    closeBtn.Position = UDim2.new(0, 130, 0, 60)
    closeBtn.AnchorPoint = Vector2.new(0, 0)
    closeBtn.BackgroundColor3 = Color3.fromRGB(255, 70, 70)
    closeBtn.BackgroundTransparency = 0.3
    closeBtn.Text = "X"
    closeBtn.TextColor3 = Color3.new(1, 1, 1)
    closeBtn.TextSize = 24
    closeBtn.Font = Enum.Font.GothamBold
    closeBtn.Parent = toggleBtn
    
    local closeCorner = Instance.new("UICorner")
    closeCorner.CornerRadius = UDim.new(0, 10)
    closeCorner.Parent = closeBtn
    
    -- æç¤ºæ¨™ç±¤
    local hintLabel = Instance.new("TextLabel")
    hintLabel.Name = "HintLabel"
    hintLabel.Size = UDim2.new(0, 250, 0, 40)
    hintLabel.Position = UDim2.new(0, -65, 0, 120)
    hintLabel.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    hintLabel.BackgroundTransparency = 0.2
    hintLabel.Text = "ğŸ’¡ Freecamä¸‹ClickTPéœ€é€£æŒ‰2æ¬¡"
    hintLabel.TextColor3 = Color3.fromRGB(255, 255, 100)
    hintLabel.TextSize = 14
    hintLabel.Font = Enum.Font.GothamBold
    hintLabel.TextWrapped = true
    hintLabel.Visible = false
    hintLabel.Parent = toggleBtn
    
    local hintCorner = Instance.new("UICorner")
    hintCorner.CornerRadius = UDim.new(0, 8)
    hintCorner.Parent = hintLabel
    
    -- é€Ÿåº¦æ§åˆ¶æ¡†æ¶(åœ¨ toggleBtn ä¸Šæ–¹)
    local speedFrame = Instance.new("Frame")
    speedFrame.Name = "SpeedFrame"
    speedFrame.Size = UDim2.new(0, 220, 0, 50)
    speedFrame.Position = UDim2.new(0, -20, 0, -60)
    speedFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    speedFrame.BackgroundTransparency = 0.2
    speedFrame.Visible = false
    speedFrame.Parent = toggleBtn
    
    local speedFrameCorner = Instance.new("UICorner")
    speedFrameCorner.CornerRadius = UDim.new(0, 8)
    speedFrameCorner.Parent = speedFrame
    
    -- é€Ÿåº¦æ¨™ç±¤
    local speedLabelText = Instance.new("TextLabel")
    speedLabelText.Size = UDim2.new(0, 65, 1, 0)
    speedLabelText.Position = UDim2.new(0, 8, 0, 0)
    speedLabelText.BackgroundTransparency = 1
    speedLabelText.Text = "é€Ÿåº¦:"
    speedLabelText.TextColor3 = Color3.new(1, 1, 1)
    speedLabelText.TextSize = 18
    speedLabelText.Font = Enum.Font.GothamBold
    speedLabelText.TextXAlignment = Enum.TextXAlignment.Left
    speedLabelText.Parent = speedFrame
    
    -- æ¸›å°‘æŒ‰éˆ•
    local speedMinusBtn = Instance.new("TextButton")
    speedMinusBtn.Name = "SpeedMinusBtn"
    speedMinusBtn.Size = UDim2.new(0, 40, 0, 40)
    speedMinusBtn.Position = UDim2.new(0, 65, 0, 5)
    speedMinusBtn.BackgroundColor3 = Color3.fromRGB(180, 70, 70)
    speedMinusBtn.BackgroundTransparency = 0.3
    speedMinusBtn.Text = "âˆ’"
    speedMinusBtn.TextColor3 = Color3.new(1, 1, 1)
    speedMinusBtn.TextSize = 28
    speedMinusBtn.Font = Enum.Font.GothamBold
    speedMinusBtn.Parent = speedFrame
    
    local minusBtnCorner = Instance.new("UICorner")
    minusBtnCorner.CornerRadius = UDim.new(0, 8)
    minusBtnCorner.Parent = speedMinusBtn
    
    -- é€Ÿåº¦è¼¸å…¥æ¡†
    local speedInput = Instance.new("TextBox")
    speedInput.Name = "SpeedInput"
    speedInput.Size = UDim2.new(0, 50, 0, 40)
    speedInput.Position = UDim2.new(0, 110, 0, 5)
    speedInput.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    speedInput.BackgroundTransparency = 0.3
    speedInput.Text = "1"
    speedInput.TextColor3 = Color3.new(1, 1, 1)
    speedInput.TextSize = 22
    speedInput.Font = Enum.Font.GothamBold
    speedInput.TextXAlignment = Enum.TextXAlignment.Center
    speedInput.ClearTextOnFocus = false
    speedInput.Parent = speedFrame
    
    local inputCorner = Instance.new("UICorner")
    inputCorner.CornerRadius = UDim.new(0, 8)
    inputCorner.Parent = speedInput
    
    -- å¢åŠ æŒ‰éˆ•
    local speedPlusBtn = Instance.new("TextButton")
    speedPlusBtn.Name = "SpeedPlusBtn"
    speedPlusBtn.Size = UDim2.new(0, 40, 0, 40)
    speedPlusBtn.Position = UDim2.new(0, 165, 0, 5)
    speedPlusBtn.BackgroundColor3 = Color3.fromRGB(70, 180, 70)
    speedPlusBtn.BackgroundTransparency = 0.3
    speedPlusBtn.Text = "+"
    speedPlusBtn.TextColor3 = Color3.new(1, 1, 1)
    speedPlusBtn.TextSize = 28
    speedPlusBtn.Font = Enum.Font.GothamBold
    speedPlusBtn.Parent = speedFrame
    
    local plusBtnCorner = Instance.new("UICorner")
    plusBtnCorner.CornerRadius = UDim.new(0, 8)
    plusBtnCorner.Parent = speedPlusBtn
    
    return screenGui, moveFrame, lookFrame, speedUpBtn, speedDownBtn, toggleBtn, minimizeBtn, closeBtn, clickTpBtn, hintLabel, speedFrame, speedInput, speedMinusBtn, speedPlusBtn
end

-- ä¿å­˜è§’è‰²åŸå§‹ä½ç½®
local savedCharacterCFrame = nil
local rootPart = nil

-- å•Ÿç”¨ Freecam
local function enableFreecam()
    freecamEnabled = true
    camera.CameraType = Enum.CameraType.Scriptable
    cameraCFrame = camera.CFrame
    
    if character then
        rootPart = character:FindFirstChild("HumanoidRootPart")
        if rootPart then
            savedCharacterCFrame = rootPart.CFrame
            rootPart.Anchored = true
        end
        
        local humanoid = character:FindFirstChildOfClass("Humanoid")
        if humanoid then
            humanoid.AutoRotate = false
            humanoid.WalkSpeed = 0
            humanoid.JumpPower = 0
            humanoid.JumpHeight = 0
        end
    end
end

-- ç¦ç”¨ Freecam
local function disableFreecam()
    freecamEnabled = false
    camera.CameraType = Enum.CameraType.Custom
    
    if character then
        if rootPart then
            rootPart.Anchored = false
        end
        
        local humanoid = character:FindFirstChildOfClass("Humanoid")
        if humanoid then
            humanoid.AutoRotate = true
            humanoid.WalkSpeed = 16
            humanoid.JumpPower = 50
            humanoid.JumpHeight = 7.2
        end
        camera.CameraSubject = character:FindFirstChildOfClass("Humanoid")
    end
    
    rootPart = nil
    savedCharacterCFrame = nil
    
    -- æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
    if toggleBtn then
        toggleBtn.Text = "é–‹å•Ÿ Freecam"
        toggleBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 255)
        if not isMinimized then
            moveFrame.Visible = false
            lookFrame.Visible = false
            speedUpBtn.Visible = false
            speedDownBtn.Visible = false
            speedFrame.Visible = false  -- éš±è—é€Ÿåº¦æ¡†
        end
    end
end

-- åˆå§‹åŒ–
local screenGui, moveFrame, lookFrame, speedUpBtn, speedDownBtn, toggleBtn, minimizeBtn, closeBtn, clickTpBtn, hintLabel, speedFrame, speedInput, speedMinusBtn, speedPlusBtn = createTouchGUI()

-- æ›´æ–°é€Ÿåº¦å‡½æ•¸
local function updateSpeed()
    moveSpeed = baseSpeed * speedMultiplier
    verticalSpeed = baseVerticalSpeed * speedMultiplier
end

-- é€Ÿåº¦è¼¸å…¥æ¡†é‚è¼¯
speedInput.FocusLost:Connect(function(enterPressed)
    local value = tonumber(speedInput.Text)
    if value and value >= 0 and value <= 99 then
        speedMultiplier = value
        -- æ ¼å¼åŒ–é¡¯ç¤ºï¼ˆå¦‚æœæ˜¯æ•´æ•¸å°±ä¸é¡¯ç¤ºå°æ•¸é»ï¼‰
        if speedMultiplier == math.floor(speedMultiplier) then
            speedInput.Text = tostring(math.floor(speedMultiplier))
        else
            speedInput.Text = string.format("%.2f", speedMultiplier)
        end
        updateSpeed()
        print("é€Ÿåº¦å€æ•¸è¨­ç‚º: " .. speedMultiplier .. "x")
    else
        -- æ ¼å¼åŒ–é¡¯ç¤ºç•¶å‰å€¼
        if speedMultiplier == math.floor(speedMultiplier) then
            speedInput.Text = tostring(math.floor(speedMultiplier))
        else
            speedInput.Text = string.format("%.2f", speedMultiplier)
        end
    end
end)

-- æ¸›å°‘é€Ÿåº¦æŒ‰éˆ•
speedMinusBtn.MouseButton1Click:Connect(function()
    if speedMultiplier > 0 then
        speedMultiplier = math.max(0, speedMultiplier - 1)
        if speedMultiplier == math.floor(speedMultiplier) then
            speedInput.Text = tostring(math.floor(speedMultiplier))
        else
            speedInput.Text = string.format("%.2f", speedMultiplier)
        end
        updateSpeed()
        print("é€Ÿåº¦å€æ•¸: " .. speedMultiplier .. "x")
    end
end)

-- å¢åŠ é€Ÿåº¦æŒ‰éˆ•
speedPlusBtn.MouseButton1Click:Connect(function()
    if speedMultiplier < 99 then
        speedMultiplier = math.min(99, speedMultiplier + 1)
        if speedMultiplier == math.floor(speedMultiplier) then
            speedInput.Text = tostring(math.floor(speedMultiplier))
        else
            speedInput.Text = string.format("%.2f", speedMultiplier)
        end
        updateSpeed()
        print("é€Ÿåº¦å€æ•¸: " .. speedMultiplier .. "x")
    end
end)

-- ç¸®å°/å±•é–‹åŠŸèƒ½
local function toggleMinimize()
    isMinimized = not isMinimized
    
    if isMinimized then
        -- ç¸®å°ï¼šéš±è—æ‰€æœ‰æŒ‰éˆ•ï¼ˆé™¤äº†ç¸®å°éˆ•ï¼‰
        minimizeBtn.Text = "+"
        toggleBtn.Visible = false
        clickTpBtn.Visible = false
        closeBtn.Visible = false
        hintLabel.Visible = false
        speedFrame.Visible = false
        
        -- å¦‚æœ Freecam é–‹å•Ÿï¼Œä¹Ÿéš±è—æ“æ§æŒ‰éˆ•
        if freecamEnabled then
            moveFrame.Visible = false
            lookFrame.Visible = false
            speedUpBtn.Visible = false
            speedDownBtn.Visible = false
        end
    else
        -- å±•é–‹ï¼šé¡¯ç¤ºæŒ‰éˆ•
        minimizeBtn.Text = "âˆ’"
        toggleBtn.Visible = true
        clickTpBtn.Visible = true
        closeBtn.Visible = true
        
        -- å¦‚æœ Freecam é–‹å•Ÿï¼Œé¡¯ç¤ºæ“æ§æŒ‰éˆ•å’Œé€Ÿåº¦æ¡†
        if freecamEnabled then
            moveFrame.Visible = true
            lookFrame.Visible = true
            speedUpBtn.Visible = true
            speedDownBtn.Visible = true
            speedFrame.Visible = true
            
            -- å¦‚æœ ClickTP é–‹å•Ÿï¼Œé¡¯ç¤ºæç¤º
            if clickTpEnabled then
                hintLabel.Visible = true
            end
        end
    end
end

-- ç›£è½è§’è‰²æ­»äº¡
local function onCharacterAdded(newCharacter)
    character = newCharacter
    
    local humanoid = character:WaitForChild("Humanoid")
    humanoid.Died:Connect(function()
        if freecamEnabled then
            freecamEnabled = false
            camera.CameraType = Enum.CameraType.Custom
            
            -- æ›´æ–°æŒ‰éˆ•å’ŒUIç‹€æ…‹
            toggleBtn.Text = "é–‹å•Ÿ Freecam"
            toggleBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 255)
            if not isMinimized then
                moveFrame.Visible = false
                lookFrame.Visible = false
                speedUpBtn.Visible = false
                speedDownBtn.Visible = false
                speedFrame.Visible = false  -- éš±è—é€Ÿåº¦æ¡†
            end
            
            rootPart = nil
            savedCharacterCFrame = nil
            
            print("è§’è‰²æ­»äº¡ï¼ŒFreecam å·²è‡ªå‹•é—œé–‰")
        end
    end)
end

-- åˆå§‹è§’è‰²
if character then
    onCharacterAdded(character)
end

-- ç›£è½è§’è‰²é‡ç”Ÿ
player.CharacterAdded:Connect(onCharacterAdded)

-- è¿½è¹¤æ‹–æ‹½ç‹€æ…‹
local isDragging = false
local dragStartPos = nil
local minimizeDragStart = nil

-- ç¸®å°æŒ‰éˆ•æ‹–æ‹½é‚è¼¯
minimizeBtn.MouseButton1Down:Connect(function()
    minimizeDragStart = minimizeBtn.Position
    isDragging = false
end)

minimizeBtn:GetPropertyChangedSignal("Position"):Connect(function()
    if minimizeDragStart then
        isDragging = true
        -- è¨ˆç®—åç§»é‡
        local offset = minimizeBtn.Position - minimizeDragStart
        
        -- åŒæ­¥ç§»å‹•æ‰€æœ‰æŒ‰éˆ•
        toggleBtn.Position = toggleBtn.Position + offset
        
        -- æ›´æ–°èµ·å§‹ä½ç½®
        minimizeDragStart = minimizeBtn.Position
    end
end)

toggleBtn.MouseButton1Down:Connect(function()
    isDragging = false
end)

-- é˜²æ­¢æŒ‰éˆ•è§¸ç™¼æ‹–æ‹½
clickTpBtn.MouseButton1Down:Connect(function()
    -- é˜»æ­¢äº‹ä»¶å†’æ³¡
end)

closeBtn.MouseButton1Down:Connect(function()
    -- é˜»æ­¢äº‹ä»¶å†’æ³¡
end)

minimizeBtn.MouseButton1Down:Connect(function()
    -- é˜»æ­¢äº‹ä»¶å†’æ³¡
end)

speedMinusBtn.MouseButton1Down:Connect(function()
    -- é˜»æ­¢äº‹ä»¶å†’æ³¡
end)

speedPlusBtn.MouseButton1Down:Connect(function()
    -- é˜»æ­¢äº‹ä»¶å†’æ³¡
end)

speedInput.Focused:Connect(function()
    -- è¼¸å…¥æ¡†ç²å¾—ç„¦é»æ™‚ï¼Œæš«æ™‚ç¦ç”¨æ‹–æ‹½
    minimizeBtn.Draggable = false
end)

speedInput.FocusLost:Connect(function()
    -- è¼¸å…¥æ¡†å¤±å»ç„¦é»æ™‚ï¼Œæ¢å¾©æ‹–æ‹½
    task.wait(0.1)
    minimizeBtn.Draggable = true
end)

-- ç²å–è§¸æ§ä½ç½®ç›¸å°æ–¼æ¡†æ¶ä¸­å¿ƒçš„åç§»
local function getTouchOffset(touch, frame)
    local frameCenter = frame.AbsolutePosition + frame.AbsoluteSize / 2
    local touchPos = Vector2.new(touch.Position.X, touch.Position.Y)
    local offset = touchPos - frameCenter
    local maxDist = frame.AbsoluteSize.X / 2
    return offset / maxDist
end

-- è™•ç†è§¸æ§è¼¸å…¥
UserInputService.TouchStarted:Connect(function(touch, gameProcessed)
    if gameProcessed then return end
    if not freecamEnabled then return end
    if isMinimized then return end
    
    local touchPos = Vector2.new(touch.Position.X, touch.Position.Y)
    
    -- æª¢æŸ¥æ˜¯å¦åœ¨ç§»å‹•å€åŸŸ
    local moveMin = moveFrame.AbsolutePosition
    local moveMax = moveMin + moveFrame.AbsoluteSize
    if touchPos.X >= moveMin.X and touchPos.X <= moveMax.X and
       touchPos.Y >= moveMin.Y and touchPos.Y <= moveMax.Y then
        moveTouch = touch
    end
    
    -- æª¢æŸ¥æ˜¯å¦åœ¨è¦–è§’å€åŸŸ
    local lookMin = lookFrame.AbsolutePosition
    local lookMax = lookMin + lookFrame.AbsoluteSize
    if touchPos.X >= lookMin.X and touchPos.X <= lookMax.X and
       touchPos.Y >= lookMin.Y and touchPos.Y <= lookMax.Y then
        lookTouch = touch
    end
end)

UserInputService.TouchEnded:Connect(function(touch, gameProcessed)
    if moveTouch and touch == moveTouch then
        moveTouch = nil
    end
    if lookTouch and touch == lookTouch then
        lookTouch = nil
    end
end)

-- é«˜åº¦æ§åˆ¶æŒ‰éˆ•
speedUpBtn.MouseButton1Down:Connect(function()
    speedTouch = "up"
end)

speedUpBtn.MouseButton1Up:Connect(function()
    if speedTouch == "up" then speedTouch = nil end
end)

speedDownBtn.MouseButton1Down:Connect(function()
    speedTouch = "down"
end)

speedDownBtn.MouseButton1Up:Connect(function()
    if speedTouch == "down" then speedTouch = nil end
end)

-- ç¸®å°æŒ‰éˆ•
minimizeBtn.MouseButton1Click:Connect(function()
    -- åªæœ‰åœ¨æ²’æœ‰æ‹–æ‹½æ™‚æ‰è§¸ç™¼ç¸®å°
    if not isDragging then
        toggleMinimize()
    end
    -- é‡ç½®æ‹–æ‹½ç‹€æ…‹
    isDragging = false
    minimizeDragStart = nil
end)

-- åˆ‡æ›æŒ‰éˆ•
toggleBtn.MouseButton1Click:Connect(function()
    -- åªæœ‰åœ¨æ²’æœ‰æ‹–æ‹½æ™‚æ‰è§¸ç™¼åˆ‡æ›
    if not isDragging then
        if freecamEnabled then
            disableFreecam()
            toggleBtn.Text = "é–‹å•Ÿ Freecam"
            toggleBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 255)
            if not isMinimized then
                moveFrame.Visible = false
                lookFrame.Visible = false
                speedUpBtn.Visible = false
                speedDownBtn.Visible = false
                hintLabel.Visible = false
                speedFrame.Visible = false
            end
        else
            enableFreecam()
            toggleBtn.Text = "é—œé–‰ Freecam"
            toggleBtn.BackgroundColor3 = Color3.fromRGB(255, 100, 100)
            if not isMinimized then
                moveFrame.Visible = true
                lookFrame.Visible = true
                speedUpBtn.Visible = true
                speedDownBtn.Visible = true
                speedFrame.Visible = true
                -- å¦‚æœ ClickTP é–‹å•Ÿï¼Œé¡¯ç¤ºæç¤º
                if clickTpEnabled and hintLabel then
                    hintLabel.Visible = true
                    print("Freecamé–‹å•Ÿ - æç¤ºæ¨™ç±¤å·²é¡¯ç¤º")
                end
            end
        end
    end
    -- é‡ç½®æ‹–æ‹½ç‹€æ…‹
    isDragging = false
    minimizeDragStart = nil
end)

-- é—œé–‰æŒ‰éˆ•ï¼ˆç§»é™¤æ•´å€‹ GUIï¼‰
closeBtn.MouseButton1Click:Connect(function()
    if freecamEnabled then
        disableFreecam()
    end
    screenGui:Destroy()
    print("Freecam è…³æœ¬å·²é—œé–‰")
end)

-- ClickTP æŒ‰éˆ•
clickTpBtn.MouseButton1Click:Connect(function()
    clickTpEnabled = not clickTpEnabled
    if clickTpEnabled then
        clickTpBtn.Text = "ClickTP: é–‹"
        clickTpBtn.BackgroundColor3 = Color3.fromRGB(50, 255, 50)
        print("ClickTP å·²é–‹å•Ÿ")
        -- å¦‚æœåœ¨ Freecam æ¨¡å¼ä¸‹ä¸”æœªç¸®å°ï¼Œé¡¯ç¤ºæç¤º
        if freecamEnabled and not isMinimized and hintLabel then
            hintLabel.Visible = true
            print("æç¤ºæ¨™ç±¤å·²é¡¯ç¤º")
            -- 5ç§’å¾Œè‡ªå‹•éš±è—æç¤º
            task.delay(5, function()
                if hintLabel and hintLabel.Parent then
                    hintLabel.Visible = false
                    print("æç¤ºæ¨™ç±¤å·²éš±è—")
                end
            end)
        end
    else
        clickTpBtn.Text = "ClickTP: é—œ"
        clickTpBtn.BackgroundColor3 = Color3.fromRGB(255, 165, 0)
        print("ClickTP å·²é—œé–‰")
        if hintLabel then
            hintLabel.Visible = false
        end
    end
end)

-- ClickTP åŠŸèƒ½
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if not clickTpEnabled then return end
    if input.UserInputType ~= Enum.UserInputType.MouseButton1 and 
       input.UserInputType ~= Enum.UserInputType.Touch then return end
    
    local touchPos = Vector2.new(input.Position.X, input.Position.Y)
    
    -- æª¢æŸ¥æ˜¯å¦é»æ“Šåœ¨åˆ‡æ›æŒ‰éˆ•å€åŸŸ
    if toggleBtn.Visible then
        local toggleMin = toggleBtn.AbsolutePosition
        local toggleMax = toggleMin + toggleBtn.AbsoluteSize + Vector2.new(math.max(closeBtn.AbsoluteSize.X, minimizeBtn.AbsoluteSize.X), clickTpBtn.AbsoluteSize.Y + closeBtn.AbsoluteSize.Y)
        if touchPos.X >= toggleMin.X and touchPos.X <= toggleMax.X and
           touchPos.Y >= toggleMin.Y and touchPos.Y <= toggleMax.Y then
            return
        end
    end
    
    -- æª¢æŸ¥ç¸®å°æŒ‰éˆ•å€åŸŸ
    local minMin = minimizeBtn.AbsolutePosition
    local minMax = minMin + minimizeBtn.AbsoluteSize
    if touchPos.X >= minMin.X and touchPos.X <= minMax.X and
       touchPos.Y >= minMin.Y and touchPos.Y <= minMax.Y then
        return
    end
    
    -- å¦‚æœåœ¨ Freecam æ¨¡å¼ä¸‹ä¸”æœªç¸®å°ï¼Œæª¢æŸ¥æ˜¯å¦é»æ“Šåœ¨æ§åˆ¶å€åŸŸ
    if freecamEnabled and not isMinimized then
        -- æª¢æŸ¥æ˜¯å¦åœ¨ç§»å‹•å€åŸŸ
        local moveMin = moveFrame.AbsolutePosition
        local moveMax = moveMin + moveFrame.AbsoluteSize
        if touchPos.X >= moveMin.X and touchPos.X <= moveMax.X and
           touchPos.Y >= moveMin.Y and touchPos.Y <= moveMax.Y then
            return
        end
        
        -- æª¢æŸ¥æ˜¯å¦åœ¨è¦–è§’å€åŸŸ
        local lookMin = lookFrame.AbsolutePosition
        local lookMax = lookMin + lookFrame.AbsoluteSize
        if touchPos.X >= lookMin.X and touchPos.X <= lookMax.X and
           touchPos.Y >= lookMin.Y and touchPos.Y <= lookMax.Y then
            return
        end
        
        -- æª¢æŸ¥æ˜¯å¦åœ¨ä¸Šä¸‹æŒ‰éˆ•å€åŸŸ
        local upMin = speedUpBtn.AbsolutePosition
        local upMax = upMin + speedUpBtn.AbsoluteSize
        if touchPos.X >= upMin.X and touchPos.X <= upMax.X and
           touchPos.Y >= upMin.Y and touchPos.Y <= upMax.Y then
            return
        end
        
        local downMin = speedDownBtn.AbsolutePosition
        local downMax = downMin + speedDownBtn.AbsoluteSize
        if touchPos.X >= downMin.X and touchPos.X <= downMax.X and
           touchPos.Y >= downMin.Y and touchPos.Y <= downMax.Y then
            return
        end
    end
    
    -- åŸ·è¡Œç¬ç§»
    local mouseLocation = UserInputService:GetMouseLocation()
    local unitRay = camera:ViewportPointToRay(mouseLocation.X, mouseLocation.Y)
    local raycastParams = RaycastParams.new()
    raycastParams.FilterType = Enum.RaycastFilterType.Exclude
    raycastParams.FilterDescendantsInstances = {character}
    
    local raycastResult = workspace:Raycast(unitRay.Origin, unitRay.Direction * 1000, raycastParams)
    
    if raycastResult and character then
        local hrp = character:FindFirstChild("HumanoidRootPart")
        if hrp then
            local targetPos = raycastResult.Position + Vector3.new(0, 3, 0)
            
            -- å¦‚æœåœ¨ Freecam æ¨¡å¼ä¸‹ï¼Œéœ€è¦å…ˆè§£é™¤å›ºå®šå†ç¬ç§»
            if freecamEnabled then
                hrp.Anchored = false
                hrp.CFrame = CFrame.new(targetPos)
                hrp.AssemblyLinearVelocity = Vector3.new(0, 0, 0)
                hrp.AssemblyAngularVelocity = Vector3.new(0, 0, 0)
                task.wait(0.1)
                hrp.Anchored = true
                savedCharacterCFrame = CFrame.new(targetPos)
                rootPart = hrp
            else
                hrp.CFrame = CFrame.new(targetPos)
            end
        end
    end
end)

-- åˆå§‹éš±è—æ§åˆ¶å…ƒä»¶
moveFrame.Visible = false
lookFrame.Visible = false
speedUpBtn.Visible = false
speedDownBtn.Visible = false

-- æ›´æ–°ç›¸æ©Ÿ
RunService.RenderStepped:Connect(function(deltaTime)
    if not freecamEnabled then return end
    
    -- ç¢ºä¿è§’è‰²ä¿æŒéœæ­¢
    if rootPart and savedCharacterCFrame then
        rootPart.CFrame = savedCharacterCFrame
        rootPart.AssemblyLinearVelocity = Vector3.new(0, 0, 0)
        rootPart.AssemblyAngularVelocity = Vector3.new(0, 0, 0)
    end
    
    local moveVector = Vector3.new(0, 0, 0)
    
    -- è™•ç†ç§»å‹•è§¸æ§
    if moveTouch then
        local offset = getTouchOffset(moveTouch, moveFrame)
        moveVector = Vector3.new(offset.X, 0, -offset.Y)
    end
    
    -- è™•ç†è¦–è§’è§¸æ§
    if lookTouch then
        local offset = getTouchOffset(lookTouch, lookFrame)
        local rotX = -offset.Y * rotationSpeed * 100 * deltaTime
        local rotY = -offset.X * rotationSpeed * 100 * deltaTime
        
        local lookVector = cameraCFrame.LookVector
        local rightVector = cameraCFrame.RightVector
        
        cameraCFrame = cameraCFrame * CFrame.Angles(rotX, 0, 0)
        cameraCFrame = CFrame.new(cameraCFrame.Position) * CFrame.Angles(0, rotY, 0) * CFrame.new(0, 0, 0) * (cameraCFrame - cameraCFrame.Position)
    end
    
    -- è™•ç†é«˜åº¦æ§åˆ¶
    if speedTouch == "up" then
        moveVector = moveVector + Vector3.new(0, verticalSpeed / moveSpeed, 0)
    elseif speedTouch == "down" then
        moveVector = moveVector + Vector3.new(0, -verticalSpeed / moveSpeed, 0)
    end
    
    -- æ‡‰ç”¨ç§»å‹•
    if moveVector.Magnitude > 0 then
        local cameraMoveVector = (cameraCFrame.RightVector * moveVector.X + 
                                  Vector3.new(0, moveVector.Y, 0) + 
                                  cameraCFrame.LookVector * moveVector.Z)
        cameraCFrame = cameraCFrame + (cameraMoveVector * moveSpeed)
    end
    
    camera.CFrame = cameraCFrame
end)

print("å¹³æ¿ Freecam è…³æœ¬å·²è¼‰å…¥!")
print("é»æ“Šåº•éƒ¨çš„æŒ‰éˆ•ä¾†é–‹å•Ÿ/é—œé–‰ Freecam")
print("å·¦å´æ–æ¡¿: å‰å¾Œå·¦å³ç§»å‹•")
print("å³å´æ–æ¡¿: æ—‹è½‰è¦–è§’")
print("é ‚éƒ¨æŒ‰éˆ•: ä¸Šå‡/ä¸‹é™")
print("âˆ’/+ æŒ‰éˆ•: ç¸®å°/å±•é–‹æ‰€æœ‰æ§åˆ¶æŒ‰éˆ•")
