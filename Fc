-- Roblox å¹³æ¿ Freecam è…³æœ¬
-- é©ç”¨æ–¼è§¸æ§è¢å¹•è¨­å‚™

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local ContextActionService = game:GetService("ContextActionService")

local player = Players.LocalPlayer
local camera = workspace.CurrentCamera
local character = player.Character or player.CharacterAdded:Wait()

-- Freecam ç‹€æ…‹
local freecamEnabled = false
local clickTpEnabled = false
local isMinimized = false
local cameraCFrame = camera.CFrame
local moveSpeed = 1.2
local baseSpeed = 1.2
local baseVerticalSpeed = 0.5
local speedMultiplier = 1
local verticalSpeed = 0.5
local rotationSpeed = 0.015

-- å‚³é€é»ç³»çµ±
local waypointList = {}       -- { name=string, position=Vector3, cframe=CFrame }
local waypointCounter = 0
local isPanelOpen = false
local isThroughMode = true    -- ç©¿é€æ¨¡å¼é è¨­é–‹å•Ÿ
local selectedWaypointIndex = nil  -- ç•¶å‰é¸ä¸­çš„å‚³é€é»ç´¢å¼•

-- è§¸æ§æ§åˆ¶è®Šé‡
local touchControls = {}
local moveTouch = nil
local lookTouch = nil
local speedTouch = nil

-- ========== GUI å»ºç«‹ ==========
local function createTouchGUI()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "FreecamTouchControls"
    screenGui.ResetOnSpawn = false
    screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    screenGui.DisplayOrder = 10000
    screenGui.IgnoreGuiInset = true

    local success, err = pcall(function()
        screenGui.Parent = game:GetService("CoreGui")
    end)
    if not success then
        screenGui.Parent = player.PlayerGui
    end

    -- ===== å·¦å´ç§»å‹•æ–æ¡¿ =====
    local moveFrame = Instance.new("Frame")
    moveFrame.Name = "MoveFrame"
    moveFrame.Size = UDim2.new(0, 300, 0, 300)
    moveFrame.Position = UDim2.new(0, 10, 1, -310)
    moveFrame.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    moveFrame.BackgroundTransparency = 0.8
    moveFrame.BorderSizePixel = 0
    moveFrame.Parent = screenGui

    local moveCorner = Instance.new("UICorner")
    moveCorner.CornerRadius = UDim.new(0, 150)
    moveCorner.Parent = moveFrame

    local moveLabel = Instance.new("TextLabel")
    moveLabel.Size = UDim2.new(1, 0, 1, 0)
    moveLabel.BackgroundTransparency = 1
    moveLabel.Text = "ç§»å‹•"
    moveLabel.TextColor3 = Color3.new(1, 1, 1)
    moveLabel.TextSize = 28
    moveLabel.Font = Enum.Font.GothamBold
    moveLabel.Parent = moveFrame

    -- ===== å³å´è¦–è§’æ–æ¡¿ =====
    local lookFrame = Instance.new("Frame")
    lookFrame.Name = "LookFrame"
    lookFrame.Size = UDim2.new(0, 300, 0, 300)
    lookFrame.Position = UDim2.new(1, -310, 1, -310)
    lookFrame.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    lookFrame.BackgroundTransparency = 0.8
    lookFrame.BorderSizePixel = 0
    lookFrame.Parent = screenGui

    local lookCorner = Instance.new("UICorner")
    lookCorner.CornerRadius = UDim.new(0, 150)
    lookCorner.Parent = lookFrame

    local lookLabel = Instance.new("TextLabel")
    lookLabel.Size = UDim2.new(1, 0, 1, 0)
    lookLabel.BackgroundTransparency = 1
    lookLabel.Text = "è¦–è§’"
    lookLabel.TextColor3 = Color3.new(1, 1, 1)
    lookLabel.TextSize = 28
    lookLabel.Font = Enum.Font.GothamBold
    lookLabel.Parent = lookFrame

    -- ===== ä¸Šå‡/ä¸‹é™æŒ‰éˆ• =====
    local speedUpBtn = Instance.new("TextButton")
    speedUpBtn.Name = "SpeedUpBtn"
    speedUpBtn.Size = UDim2.new(0, 80, 0, 80)
    speedUpBtn.Position = UDim2.new(0.5, -40, 0, 20)
    speedUpBtn.BackgroundColor3 = Color3.fromRGB(70, 130, 70)
    speedUpBtn.BackgroundTransparency = 0.3
    speedUpBtn.Text = "â†‘"
    speedUpBtn.TextColor3 = Color3.new(1, 1, 1)
    speedUpBtn.TextSize = 36
    speedUpBtn.Font = Enum.Font.GothamBold
    speedUpBtn.Parent = screenGui

    local upCorner = Instance.new("UICorner")
    upCorner.CornerRadius = UDim.new(0, 40)
    upCorner.Parent = speedUpBtn

    local speedDownBtn = Instance.new("TextButton")
    speedDownBtn.Name = "SpeedDownBtn"
    speedDownBtn.Size = UDim2.new(0, 80, 0, 80)
    speedDownBtn.Position = UDim2.new(0.5, -40, 0, 110)
    speedDownBtn.BackgroundColor3 = Color3.fromRGB(180, 70, 70)
    speedDownBtn.BackgroundTransparency = 0.3
    speedDownBtn.Text = "â†“"
    speedDownBtn.TextColor3 = Color3.new(1, 1, 1)
    speedDownBtn.TextSize = 36
    speedDownBtn.Font = Enum.Font.GothamBold
    speedDownBtn.Parent = screenGui

    local downCorner = Instance.new("UICorner")
    downCorner.CornerRadius = UDim.new(0, 40)
    downCorner.Parent = speedDownBtn

    -- ===== ä¸»åˆ‡æ›æŒ‰éˆ• =====
    local toggleBtn = Instance.new("TextButton")
    toggleBtn.Name = "ToggleBtn"
    toggleBtn.Size = UDim2.new(0, 120, 0, 50)
    toggleBtn.Position = UDim2.new(0.5, -70, 1, -200)
    toggleBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 255)
    toggleBtn.BackgroundTransparency = 0.3
    toggleBtn.Text = "é–‹å•Ÿ Freecam"
    toggleBtn.TextColor3 = Color3.new(1, 1, 1)
    toggleBtn.TextSize = 18
    toggleBtn.Font = Enum.Font.GothamBold
    toggleBtn.Active = false
    toggleBtn.Draggable = false
    toggleBtn.Parent = screenGui

    local toggleCorner = Instance.new("UICorner")
    toggleCorner.CornerRadius = UDim.new(0, 10)
    toggleCorner.Parent = toggleBtn

    -- ===== ç¸®å°æŒ‰éˆ•ï¼ˆå¯æ‹–æ‹½ï¼‰=====
    local minimizeBtn = Instance.new("TextButton")
    minimizeBtn.Name = "MinimizeBtn"
    minimizeBtn.Size = UDim2.new(0, 50, 0, 50)
    minimizeBtn.Position = UDim2.new(0.5, 60, 1, -200)
    minimizeBtn.AnchorPoint = Vector2.new(0, 0)
    minimizeBtn.BackgroundColor3 = Color3.fromRGB(120, 120, 120)
    minimizeBtn.BackgroundTransparency = 0.3
    minimizeBtn.Text = "âˆ’"
    minimizeBtn.TextColor3 = Color3.new(1, 1, 1)
    minimizeBtn.TextSize = 32
    minimizeBtn.Font = Enum.Font.GothamBold
    minimizeBtn.Active = true
    minimizeBtn.Draggable = true
    minimizeBtn.Parent = screenGui

    local minimizeCorner = Instance.new("UICorner")
    minimizeCorner.CornerRadius = UDim.new(0, 10)
    minimizeCorner.Parent = minimizeBtn

    -- ===== å°è—æŒ‰éˆ•ï¼ˆæ¸…å–®é¢æ¿é–‹é—œï¼‰=====
    -- å°ºå¯¸ç‚ºç¸®å°éµçš„ 1/2ï¼š25x25
    local listBtn = Instance.new("TextButton")
    listBtn.Name = "ListBtn"
    listBtn.Size = UDim2.new(0, 25, 0, 25)
    listBtn.Position = UDim2.new(0.5, 115, 1, -200)  -- ç·Šé  minimizeBtn å³å´
    listBtn.AnchorPoint = Vector2.new(0, 0)
    listBtn.BackgroundColor3 = Color3.fromRGB(50, 120, 255)
    listBtn.BackgroundTransparency = 0.2
    listBtn.Text = "Â·Â·Â·"
    listBtn.TextColor3 = Color3.new(1, 1, 1)
    listBtn.TextSize = 12
    listBtn.Font = Enum.Font.GothamBold
    listBtn.Parent = screenGui

    local listBtnCorner = Instance.new("UICorner")
    listBtnCorner.CornerRadius = UDim.new(0, 6)
    listBtnCorner.Parent = listBtn

    -- ===== ClickTP æŒ‰éˆ•ï¼ˆåœ¨ toggleBtn ä¸‹æ–¹ï¼‰=====
    local clickTpBtn = Instance.new("TextButton")
    clickTpBtn.Name = "ClickTpBtn"
    clickTpBtn.Size = UDim2.new(0, 120, 0, 50)
    clickTpBtn.Position = UDim2.new(0, 0, 0, 60)
    clickTpBtn.BackgroundColor3 = Color3.fromRGB(255, 165, 0)
    clickTpBtn.BackgroundTransparency = 0.3
    clickTpBtn.Text = "ClickTP: é—œ"
    clickTpBtn.TextColor3 = Color3.new(1, 1, 1)
    clickTpBtn.TextSize = 18
    clickTpBtn.Font = Enum.Font.GothamBold
    clickTpBtn.Parent = toggleBtn

    local clickTpCorner = Instance.new("UICorner")
    clickTpCorner.CornerRadius = UDim.new(0, 10)
    clickTpCorner.Parent = clickTpBtn

    -- ===== é—œé–‰æŒ‰éˆ• =====
    local closeBtn = Instance.new("TextButton")
    closeBtn.Name = "CloseBtn"
    closeBtn.Size = UDim2.new(0, 50, 0, 50)
    closeBtn.Position = UDim2.new(0, 130, 0, 60)
    closeBtn.AnchorPoint = Vector2.new(0, 0)
    closeBtn.BackgroundColor3 = Color3.fromRGB(255, 70, 70)
    closeBtn.BackgroundTransparency = 0.3
    closeBtn.Text = "X"
    closeBtn.TextColor3 = Color3.new(1, 1, 1)
    closeBtn.TextSize = 24
    closeBtn.Font = Enum.Font.GothamBold
    closeBtn.Parent = toggleBtn

    local closeCorner = Instance.new("UICorner")
    closeCorner.CornerRadius = UDim.new(0, 10)
    closeCorner.Parent = closeBtn

    -- ===== æç¤ºæ¨™ç±¤ =====
    local hintLabel = Instance.new("TextLabel")
    hintLabel.Name = "HintLabel"
    hintLabel.Size = UDim2.new(0, 250, 0, 40)
    hintLabel.Position = UDim2.new(0, -65, 0, 120)
    hintLabel.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    hintLabel.BackgroundTransparency = 0.2
    hintLabel.Text = "ğŸ’¡ Freecamä¸‹ClickTPéœ€é€£æŒ‰2æ¬¡"
    hintLabel.TextColor3 = Color3.fromRGB(255, 255, 100)
    hintLabel.TextSize = 14
    hintLabel.Font = Enum.Font.GothamBold
    hintLabel.TextWrapped = true
    hintLabel.Visible = false
    hintLabel.Parent = toggleBtn

    local hintCorner = Instance.new("UICorner")
    hintCorner.CornerRadius = UDim.new(0, 8)
    hintCorner.Parent = hintLabel

    -- ===== é€Ÿåº¦æ§åˆ¶æ¡†æ¶ =====
    local speedFrame = Instance.new("Frame")
    speedFrame.Name = "SpeedFrame"
    speedFrame.Size = UDim2.new(0, 220, 0, 50)
    speedFrame.Position = UDim2.new(0, -20, 0, -60)
    speedFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    speedFrame.BackgroundTransparency = 0.2
    speedFrame.Visible = false
    speedFrame.Parent = toggleBtn

    local speedFrameCorner = Instance.new("UICorner")
    speedFrameCorner.CornerRadius = UDim.new(0, 8)
    speedFrameCorner.Parent = speedFrame

    local speedLabelText = Instance.new("TextLabel")
    speedLabelText.Size = UDim2.new(0, 65, 1, 0)
    speedLabelText.Position = UDim2.new(0, 8, 0, 0)
    speedLabelText.BackgroundTransparency = 1
    speedLabelText.Text = "é€Ÿåº¦:"
    speedLabelText.TextColor3 = Color3.new(1, 1, 1)
    speedLabelText.TextSize = 18
    speedLabelText.Font = Enum.Font.GothamBold
    speedLabelText.TextXAlignment = Enum.TextXAlignment.Left
    speedLabelText.Parent = speedFrame

    local speedMinusBtn = Instance.new("TextButton")
    speedMinusBtn.Name = "SpeedMinusBtn"
    speedMinusBtn.Size = UDim2.new(0, 40, 0, 40)
    speedMinusBtn.Position = UDim2.new(0, 65, 0, 5)
    speedMinusBtn.BackgroundColor3 = Color3.fromRGB(180, 70, 70)
    speedMinusBtn.BackgroundTransparency = 0.3
    speedMinusBtn.Text = "âˆ’"
    speedMinusBtn.TextColor3 = Color3.new(1, 1, 1)
    speedMinusBtn.TextSize = 28
    speedMinusBtn.Font = Enum.Font.GothamBold
    speedMinusBtn.Parent = speedFrame

    local minusBtnCorner = Instance.new("UICorner")
    minusBtnCorner.CornerRadius = UDim.new(0, 8)
    minusBtnCorner.Parent = speedMinusBtn

    local speedInput = Instance.new("TextBox")
    speedInput.Name = "SpeedInput"
    speedInput.Size = UDim2.new(0, 50, 0, 40)
    speedInput.Position = UDim2.new(0, 110, 0, 5)
    speedInput.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    speedInput.BackgroundTransparency = 0.3
    speedInput.Text = "1"
    speedInput.TextColor3 = Color3.new(1, 1, 1)
    speedInput.TextSize = 22
    speedInput.Font = Enum.Font.GothamBold
    speedInput.TextXAlignment = Enum.TextXAlignment.Center
    speedInput.ClearTextOnFocus = false
    speedInput.Parent = speedFrame

    local inputCorner = Instance.new("UICorner")
    inputCorner.CornerRadius = UDim.new(0, 8)
    inputCorner.Parent = speedInput

    local speedPlusBtn = Instance.new("TextButton")
    speedPlusBtn.Name = "SpeedPlusBtn"
    speedPlusBtn.Size = UDim2.new(0, 40, 0, 40)
    speedPlusBtn.Position = UDim2.new(0, 165, 0, 5)
    speedPlusBtn.BackgroundColor3 = Color3.fromRGB(70, 180, 70)
    speedPlusBtn.BackgroundTransparency = 0.3
    speedPlusBtn.Text = "+"
    speedPlusBtn.TextColor3 = Color3.new(1, 1, 1)
    speedPlusBtn.TextSize = 28
    speedPlusBtn.Font = Enum.Font.GothamBold
    speedPlusBtn.Parent = speedFrame

    local plusBtnCorner = Instance.new("UICorner")
    plusBtnCorner.CornerRadius = UDim.new(0, 8)
    plusBtnCorner.Parent = speedPlusBtn

    -- ========== å‚³é€é»æ¸…å–®é¢æ¿ï¼ˆ160Ã—210ï¼‰==========
    -- é¢æ¿å·¦é‚Š = minimizeBtn å³é‚Šï¼š0.5scale + (60+50)offset = 0.5scale+110offset
    -- é¢æ¿é ‚éƒ¨ = minimizeBtn é ‚éƒ¨ï¼š1scale + (-200)offset
    local panelFrame = Instance.new("Frame")
    panelFrame.Name = "WaypointPanel"
    panelFrame.Size = UDim2.new(0, 160, 0, 210)
    panelFrame.Position = UDim2.new(0.5, 115, 1, -200)  -- å·¦é‚Š = minimizeBtnå³é‚Šï¼Œé ‚éƒ¨ = minimizeBtné ‚éƒ¨
    panelFrame.AnchorPoint = Vector2.new(0, 0)
    panelFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
    panelFrame.BackgroundTransparency = 0.1
    panelFrame.BorderSizePixel = 0
    panelFrame.Visible = false
    panelFrame.ZIndex = 200
    panelFrame.Parent = screenGui

    local panelCorner = Instance.new("UICorner")
    panelCorner.CornerRadius = UDim.new(0, 10)
    panelCorner.Parent = panelFrame

    -- é¢æ¿æ¨™é¡Œåˆ—ï¼ˆé«˜åº¦ 22ï¼‰
    local panelTitleBar = Instance.new("Frame")
    panelTitleBar.Name = "TitleBar"
    panelTitleBar.Size = UDim2.new(1, 0, 0, 22)
    panelTitleBar.Position = UDim2.new(0, 0, 0, 0)
    panelTitleBar.BackgroundColor3 = Color3.fromRGB(35, 35, 50)
    panelTitleBar.BackgroundTransparency = 0.0
    panelTitleBar.BorderSizePixel = 0
    panelTitleBar.ZIndex = 201
    panelTitleBar.Parent = panelFrame

    local panelTitleCorner = Instance.new("UICorner")
    panelTitleCorner.CornerRadius = UDim.new(0, 10)
    panelTitleCorner.Parent = panelTitleBar

    -- æ¨™é¡Œåˆ—åº•éƒ¨è£œä¸ï¼ˆé®ä½ä¸‹åœ“è§’ï¼‰
    local titlePatch = Instance.new("Frame")
    titlePatch.Size = UDim2.new(1, 0, 0, 10)
    titlePatch.Position = UDim2.new(0, 0, 1, -10)
    titlePatch.BackgroundColor3 = Color3.fromRGB(35, 35, 50)
    titlePatch.BackgroundTransparency = 0.0
    titlePatch.BorderSizePixel = 0
    titlePatch.ZIndex = 201
    titlePatch.Parent = panelTitleBar

    local panelTitle = Instance.new("TextLabel")
    panelTitle.Size = UDim2.new(1, -28, 1, 0)
    panelTitle.Position = UDim2.new(0, 28, 0, 0)
    panelTitle.BackgroundTransparency = 1
    panelTitle.Text = "ğŸ“ å‚³é€é»æ¸…å–®"
    panelTitle.TextColor3 = Color3.fromRGB(200, 210, 255)
    panelTitle.TextSize = 10
    panelTitle.Font = Enum.Font.GothamBold
    panelTitle.TextXAlignment = Enum.TextXAlignment.Left
    panelTitle.ZIndex = 202
    panelTitle.Parent = panelTitleBar

    -- å°è—æŒ‰éˆ•ä½”ä½æ¡†ï¼ˆ22Ã—22ï¼Œåœ¨æ¨™é¡Œåˆ—å·¦é‚Šï¼‰
    local panelListBtnPlaceholder = Instance.new("Frame")
    panelListBtnPlaceholder.Name = "PanelListBtnHolder"
    panelListBtnPlaceholder.Size = UDim2.new(0, 22, 0, 22)
    panelListBtnPlaceholder.Position = UDim2.new(0, 2, 0, 0)
    panelListBtnPlaceholder.BackgroundTransparency = 1
    panelListBtnPlaceholder.ZIndex = 203
    panelListBtnPlaceholder.Parent = panelTitleBar

    -- ===== ä¸Šå±¤å›ºå®šå€ï¼ˆé«˜åº¦ 70ï¼‰=====
    local topFixed = Instance.new("Frame")
    topFixed.Name = "TopFixed"
    topFixed.Size = UDim2.new(1, 0, 0, 70)
    topFixed.Position = UDim2.new(0, 0, 0, 22)
    topFixed.BackgroundColor3 = Color3.fromRGB(30, 30, 42)
    topFixed.BackgroundTransparency = 0.0
    topFixed.BorderSizePixel = 0
    topFixed.ZIndex = 201
    topFixed.Parent = panelFrame

    -- è¨­å®šå‚³é€é»æŒ‰éˆ•ï¼ˆé«˜åº¦ 20ï¼‰
    local setWaypointBtn = Instance.new("TextButton")
    setWaypointBtn.Name = "SetWaypointBtn"
    setWaypointBtn.Size = UDim2.new(1, -10, 0, 20)
    setWaypointBtn.Position = UDim2.new(0, 5, 0, 4)
    setWaypointBtn.BackgroundColor3 = Color3.fromRGB(50, 160, 100)
    setWaypointBtn.BackgroundTransparency = 0.2
    setWaypointBtn.Text = "ğŸ“Œ è¨­å®šå‚³é€é»ï¼ˆè§’è‰²ä½ç½®ï¼‰"
    setWaypointBtn.TextColor3 = Color3.new(1, 1, 1)
    setWaypointBtn.TextSize = 8
    setWaypointBtn.Font = Enum.Font.GothamBold
    setWaypointBtn.TextWrapped = true
    setWaypointBtn.ZIndex = 202
    setWaypointBtn.Parent = topFixed

    local setWpCorner = Instance.new("UICorner")
    setWpCorner.CornerRadius = UDim.new(0, 5)
    setWpCorner.Parent = setWaypointBtn

    -- å‚³é€åˆ°æŒ‡å®šé»æŒ‰éˆ•ï¼ˆé«˜åº¦ 20ï¼‰
    local tpToWaypointBtn = Instance.new("TextButton")
    tpToWaypointBtn.Name = "TpToWaypointBtn"
    tpToWaypointBtn.Size = UDim2.new(1, -10, 0, 20)
    tpToWaypointBtn.Position = UDim2.new(0, 5, 0, 28)
    tpToWaypointBtn.BackgroundColor3 = Color3.fromRGB(60, 100, 210)
    tpToWaypointBtn.BackgroundTransparency = 0.2
    tpToWaypointBtn.Text = "ğŸš€ å‚³é€åˆ°é¸å®šé»ï¼ˆè§’è‰²ç§»å‹•ï¼‰"
    tpToWaypointBtn.TextColor3 = Color3.new(1, 1, 1)
    tpToWaypointBtn.TextSize = 8
    tpToWaypointBtn.Font = Enum.Font.GothamBold
    tpToWaypointBtn.TextWrapped = true
    tpToWaypointBtn.ZIndex = 202
    tpToWaypointBtn.Parent = topFixed

    local tpWpCorner = Instance.new("UICorner")
    tpWpCorner.CornerRadius = UDim.new(0, 5)
    tpWpCorner.Parent = tpToWaypointBtn

    -- ç©¿é€æ¨¡å¼å‹¾é¸åˆ—ï¼ˆé«˜åº¦ 18ï¼‰
    local throughRow = Instance.new("Frame")
    throughRow.Size = UDim2.new(1, -10, 0, 18)
    throughRow.Position = UDim2.new(0, 5, 0, 52)
    throughRow.BackgroundColor3 = Color3.fromRGB(40, 40, 58)
    throughRow.BackgroundTransparency = 0.2
    throughRow.BorderSizePixel = 0
    throughRow.ZIndex = 202
    throughRow.Parent = topFixed

    local throughRowCorner = Instance.new("UICorner")
    throughRowCorner.CornerRadius = UDim.new(0, 5)
    throughRowCorner.Parent = throughRow

    -- å‹¾é¸æ¡†ï¼ˆ14Ã—14ï¼‰
    local throughCheck = Instance.new("TextButton")
    throughCheck.Name = "ThroughCheck"
    throughCheck.Size = UDim2.new(0, 14, 0, 14)
    throughCheck.Position = UDim2.new(0, 3, 0, 2)
    throughCheck.BackgroundColor3 = Color3.fromRGB(50, 160, 100)
    throughCheck.BackgroundTransparency = 0.1
    throughCheck.Text = "âœ“"
    throughCheck.TextColor3 = Color3.new(1, 1, 1)
    throughCheck.TextSize = 10
    throughCheck.Font = Enum.Font.GothamBold
    throughCheck.ZIndex = 203
    throughCheck.Parent = throughRow

    local throughCheckCorner = Instance.new("UICorner")
    throughCheckCorner.CornerRadius = UDim.new(0, 4)
    throughCheckCorner.Parent = throughCheck

    local throughLabel = Instance.new("TextLabel")
    throughLabel.Size = UDim2.new(1, -22, 1, 0)
    throughLabel.Position = UDim2.new(0, 20, 0, 0)
    throughLabel.BackgroundTransparency = 1
    throughLabel.Text = "ç©¿é€æ¨¡å¼ï¼ˆç„¡è¦–é€æ˜ç‰©ä»¶ï¼‰"
    throughLabel.TextColor3 = Color3.fromRGB(200, 210, 255)
    throughLabel.TextSize = 8
    throughLabel.Font = Enum.Font.Gotham
    throughLabel.TextXAlignment = Enum.TextXAlignment.Left
    throughLabel.TextWrapped = true
    throughLabel.ZIndex = 203
    throughLabel.Parent = throughRow

    -- ===== ä¸‹å±¤å¯æ»‘å‹•æ¸…å–®å€ï¼ˆé¢æ¿210 - æ¨™é¡Œ22 - ä¸Šå±¤70 = 118ï¼‰=====
    local listArea = Instance.new("Frame")
    listArea.Name = "ListArea"
    listArea.Size = UDim2.new(1, 0, 1, -92)
    listArea.Position = UDim2.new(0, 0, 0, 92)
    listArea.BackgroundColor3 = Color3.fromRGB(20, 20, 30)
    listArea.BackgroundTransparency = 0.0
    listArea.BorderSizePixel = 0
    listArea.ClipsDescendants = true
    listArea.ZIndex = 201
    listArea.Parent = panelFrame

    local listAreaBottomCorner = Instance.new("UICorner")
    listAreaBottomCorner.CornerRadius = UDim.new(0, 10)
    listAreaBottomCorner.Parent = listArea

    -- ç©ºåˆ—è¡¨æç¤º
    local emptyLabel = Instance.new("TextLabel")
    emptyLabel.Name = "EmptyLabel"
    emptyLabel.Size = UDim2.new(1, 0, 1, 0)
    emptyLabel.BackgroundTransparency = 1
    emptyLabel.Text = "å°šç„¡å‚³é€é»\né»æ“Šä¸Šæ–¹æŒ‰éˆ•æ–°å¢"
    emptyLabel.TextColor3 = Color3.fromRGB(120, 120, 150)
    emptyLabel.TextSize = 9
    emptyLabel.Font = Enum.Font.Gotham
    emptyLabel.ZIndex = 202
    emptyLabel.Parent = listArea

    -- ScrollingFrameï¼ˆå¯æ»‘å‹•ï¼‰
    local scrollFrame = Instance.new("ScrollingFrame")
    scrollFrame.Name = "ScrollFrame"
    scrollFrame.Size = UDim2.new(1, 0, 1, 0)
    scrollFrame.Position = UDim2.new(0, 0, 0, 0)
    scrollFrame.BackgroundTransparency = 1
    scrollFrame.BorderSizePixel = 0
    scrollFrame.ScrollBarThickness = 3
    scrollFrame.ScrollBarImageColor3 = Color3.fromRGB(80, 100, 200)
    scrollFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
    scrollFrame.ZIndex = 202
    scrollFrame.Parent = listArea

    local listLayout = Instance.new("UIListLayout")
    listLayout.Padding = UDim.new(0, 3)
    listLayout.SortOrder = Enum.SortOrder.LayoutOrder
    listLayout.Parent = scrollFrame

    local listPadding = Instance.new("UIPadding")
    listPadding.PaddingTop = UDim.new(0, 3)
    listPadding.PaddingLeft = UDim.new(0, 4)
    listPadding.PaddingRight = UDim.new(0, 4)
    listPadding.PaddingBottom = UDim.new(0, 3)
    listPadding.Parent = scrollFrame

    return screenGui, moveFrame, lookFrame, speedUpBtn, speedDownBtn, toggleBtn, minimizeBtn, closeBtn,
           clickTpBtn, hintLabel, speedFrame, speedInput, speedMinusBtn, speedPlusBtn,
           listBtn, panelFrame, setWaypointBtn, tpToWaypointBtn, throughCheck,
           scrollFrame, listLayout, emptyLabel
end

-- ========== åˆå§‹åŒ– GUI ==========
local screenGui, moveFrame, lookFrame, speedUpBtn, speedDownBtn, toggleBtn, minimizeBtn, closeBtn,
      clickTpBtn, hintLabel, speedFrame, speedInput, speedMinusBtn, speedPlusBtn,
      listBtn, panelFrame, setWaypointBtn, tpToWaypointBtn, throughCheck,
      scrollFrame, listLayout, emptyLabel = createTouchGUI()

-- ========== ä¿å­˜è§’è‰²åŸå§‹ä½ç½® ==========
local savedCharacterCFrame = nil
local rootPart = nil

-- ========== å‚³é€é»æ¸…å–® UI æ›´æ–° ==========
local function updateWaypointListUI()
    -- æ¸…é™¤èˆŠæœ‰æ¢ç›®
    for _, child in ipairs(scrollFrame:GetChildren()) do
        if child:IsA("Frame") then
            child:Destroy()
        end
    end

    if #waypointList == 0 then
        emptyLabel.Visible = true
        scrollFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
        return
    end

    emptyLabel.Visible = false

    for i, wp in ipairs(waypointList) do
        -- æ ¹æ“šå‚³é€é»é¡å‹é¸æ“‡åº•è‰²
        -- isCamFrame=trueï¼ˆé¡é ­é»ï¼‰ï¼šè—ç´«è‰²ç³»
        -- isCamFrame=false/nilï¼ˆè§’è‰²é»ï¼‰ï¼šç¶ é’è‰²ç³»
        local baseColor
        local selectedColor
        if wp.isCamFrame then
            baseColor = (selectedWaypointIndex == i)
                and Color3.fromRGB(60, 60, 180)
                or Color3.fromRGB(30, 30, 70)
            selectedColor = Color3.fromRGB(60, 60, 180)
        else
            baseColor = (selectedWaypointIndex == i)
                and Color3.fromRGB(30, 90, 60)
                or Color3.fromRGB(20, 50, 35)
            selectedColor = Color3.fromRGB(30, 90, 60)
        end

        local itemFrame = Instance.new("Frame")
        itemFrame.Name = "WaypointItem_" .. i
        itemFrame.Size = UDim2.new(1, 0, 0, 28)
        itemFrame.BackgroundColor3 = baseColor
        itemFrame.BackgroundTransparency = 0.15
        itemFrame.BorderSizePixel = 0
        itemFrame.LayoutOrder = i
        itemFrame.ZIndex = 203
        itemFrame.Parent = scrollFrame

        local itemCorner = Instance.new("UICorner")
        itemCorner.CornerRadius = UDim.new(0, 5)
        itemCorner.Parent = itemFrame

        -- å·¦å´è‰²æ¢ï¼ˆå€åˆ†é¡å‹ï¼‰
        local typeBar = Instance.new("Frame")
        typeBar.Size = UDim2.new(0, 3, 1, -4)
        typeBar.Position = UDim2.new(0, 2, 0, 2)
        typeBar.BackgroundColor3 = wp.isCamFrame
            and Color3.fromRGB(100, 140, 255)  -- é¡é ­é»ï¼šè—
            or Color3.fromRGB(80, 200, 130)     -- è§’è‰²é»ï¼šç¶ 
        typeBar.BackgroundTransparency = 0.0
        typeBar.BorderSizePixel = 0
        typeBar.ZIndex = 205
        typeBar.Parent = itemFrame

        local typeBarCorner = Instance.new("UICorner")
        typeBarCorner.CornerRadius = UDim.new(0, 2)
        typeBarCorner.Parent = typeBar

        -- é¸ä¸­æŒ‡ç¤ºå™¨ï¼ˆé€æ˜è¦†è“‹æ•´å€‹ frameï¼‰
        local selectBtn = Instance.new("TextButton")
        selectBtn.Size = UDim2.new(1, 0, 1, 0)
        selectBtn.BackgroundTransparency = 1
        selectBtn.Text = ""
        selectBtn.ZIndex = 204
        selectBtn.Parent = itemFrame

        -- åºè™Ÿæ¨™ç±¤
        local numLabel = Instance.new("TextLabel")
        numLabel.Size = UDim2.new(0, 16, 1, 0)
        numLabel.Position = UDim2.new(0, 8, 0, 0)
        numLabel.BackgroundTransparency = 1
        numLabel.Text = tostring(i)
        numLabel.TextColor3 = wp.isCamFrame
            and Color3.fromRGB(140, 170, 255)
            or Color3.fromRGB(120, 210, 160)
        numLabel.TextSize = 9
        numLabel.Font = Enum.Font.GothamBold
        numLabel.ZIndex = 204
        numLabel.Parent = itemFrame

        -- é¡å‹åœ–ç¤ºå°æ¨™ç±¤
        local typeIcon = Instance.new("TextLabel")
        typeIcon.Size = UDim2.new(0, 12, 1, 0)
        typeIcon.Position = UDim2.new(0, 24, 0, 0)
        typeIcon.BackgroundTransparency = 1
        typeIcon.Text = wp.isCamFrame and "ğŸ¥" or "ğŸ“Œ"
        typeIcon.TextSize = 8
        typeIcon.Font = Enum.Font.GothamBold
        typeIcon.ZIndex = 204
        typeIcon.Parent = itemFrame

        -- åç¨±æ¨™ç±¤ï¼ˆå¯æ”¹åï¼‰
        local nameLabel = Instance.new("TextBox")
        nameLabel.Name = "NameBox"
        nameLabel.Size = UDim2.new(1, -60, 1, 0)
        nameLabel.Position = UDim2.new(0, 38, 0, 0)
        nameLabel.BackgroundTransparency = 1
        nameLabel.Text = wp.name
        nameLabel.TextColor3 = Color3.fromRGB(220, 225, 255)
        nameLabel.TextSize = 9
        nameLabel.Font = Enum.Font.Gotham
        nameLabel.TextXAlignment = Enum.TextXAlignment.Left
        nameLabel.ClearTextOnFocus = false
        nameLabel.ZIndex = 205
        nameLabel.Parent = itemFrame

        -- æ”¹åé‚è¼¯
        nameLabel.FocusLost:Connect(function()
            local newName = nameLabel.Text
            if newName ~= "" then
                waypointList[i].name = newName
            else
                nameLabel.Text = waypointList[i].name
            end
        end)

        -- åˆªé™¤æŒ‰éˆ•ï¼ˆæ­£åœ“å½¢ï¼‰
        local deleteBtn = Instance.new("TextButton")
        deleteBtn.Size = UDim2.new(0, 18, 0, 18)
        deleteBtn.Position = UDim2.new(1, -21, 0.5, -9)
        deleteBtn.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
        deleteBtn.BackgroundTransparency = 0.2
        deleteBtn.Text = "Ã—"
        deleteBtn.TextColor3 = Color3.new(1, 1, 1)
        deleteBtn.TextSize = 14
        deleteBtn.Font = Enum.Font.GothamBold
        deleteBtn.ZIndex = 205
        deleteBtn.Parent = itemFrame

        local delCorner = Instance.new("UICorner")
        delCorner.CornerRadius = UDim.new(0.5, 0)  -- å®Œå…¨åœ“å½¢
        delCorner.Parent = deleteBtn

        -- é»æ“Šæ¢ç›®é¸ä¸­
        local captureIndex = i
        selectBtn.MouseButton1Click:Connect(function()
            selectedWaypointIndex = captureIndex
            updateWaypointListUI()
        end)

        deleteBtn.MouseButton1Click:Connect(function()
            table.remove(waypointList, captureIndex)
            if selectedWaypointIndex == captureIndex then
                selectedWaypointIndex = nil
            elseif selectedWaypointIndex and selectedWaypointIndex > captureIndex then
                selectedWaypointIndex = selectedWaypointIndex - 1
            end
            updateWaypointListUI()
        end)
    end

    -- æ›´æ–°æ»¾å‹•ç¯„åœ
    local itemHeight = 28
    local padding = 3
    local totalH = #waypointList * (itemHeight + padding) + padding + 6
    scrollFrame.CanvasSize = UDim2.new(0, 0, 0, totalH)
end

-- ========== æ›´æ–°æŒ‰éˆ•æ–‡å­—ï¼ˆæ ¹æ“š Freecam ç‹€æ…‹ï¼‰==========
local function updatePanelBtnTexts()
    if freecamEnabled then
        setWaypointBtn.Text = "ğŸ“· è¨­å®šé¡é ­ä½ç½®ç‚ºå‚³é€é»"
        tpToWaypointBtn.Text = "ğŸ¥ ç§»å‹•é¡é ­åˆ°é¸å®šé»"
    else
        setWaypointBtn.Text = "ğŸ“Œ è¨­å®šå‚³é€é»ï¼ˆè§’è‰²ä½ç½®ï¼‰"
        tpToWaypointBtn.Text = "ğŸš€ å‚³é€åˆ°é¸å®šé»ï¼ˆè§’è‰²ç§»å‹•ï¼‰"
    end
end

-- ========== ç©¿é€æ¨¡å¼ UI æ›´æ–° ==========
local function updateThroughCheckUI()
    if isThroughMode then
        throughCheck.Text = "âœ“"
        throughCheck.BackgroundColor3 = Color3.fromRGB(50, 160, 100)
    else
        throughCheck.Text = ""
        throughCheck.BackgroundColor3 = Color3.fromRGB(80, 80, 100)
    end
end

-- ========== é¢æ¿é–‹é—œ ==========
local function openPanel()
    isPanelOpen = true
    panelFrame.Visible = true
    updatePanelBtnTexts()
    updateWaypointListUI()

    -- æŠŠå°è—æŒ‰éˆ•ç§»åˆ°é¢æ¿æ¨™é¡Œåˆ—å·¦ä¸Šè§’ï¼ˆ22Ã—22 ä½”æ»¿ä½”ä½æ¡†ï¼‰
    listBtn.Parent = panelFrame:FindFirstChild("TitleBar"):FindFirstChild("PanelListBtnHolder")
    listBtn.Size = UDim2.new(1, 0, 1, 0)
    listBtn.Position = UDim2.new(0, 0, 0, 0)
    listBtn.AnchorPoint = Vector2.new(0, 0)
end

local function closePanel()
    isPanelOpen = false
    panelFrame.Visible = false

    -- æŠŠå°è—æŒ‰éˆ•ç§»å› screenGuiï¼Œé  minimizeBtn å³å´
    listBtn.Parent = screenGui
    listBtn.Size = UDim2.new(0, 25, 0, 25)
    listBtn.AnchorPoint = Vector2.new(0, 0)

    -- åŒæ­¥ä½ç½®ï¼šç·Šé  minimizeBtn å³é‚Š
    local minPos = minimizeBtn.Position
    listBtn.Position = UDim2.new(minPos.X.Scale, minPos.X.Offset + 55, minPos.Y.Scale, minPos.Y.Offset + 12)
end

-- ========== å•Ÿç”¨ Freecam ==========
local function enableFreecam()
    freecamEnabled = true
    camera.CameraType = Enum.CameraType.Scriptable
    cameraCFrame = camera.CFrame

    if character then
        rootPart = character:FindFirstChild("HumanoidRootPart")
        if rootPart then
            savedCharacterCFrame = rootPart.CFrame
            rootPart.Anchored = true
        end

        local humanoid = character:FindFirstChildOfClass("Humanoid")
        if humanoid then
            humanoid.AutoRotate = false
        end
    end

    if isPanelOpen then
        updatePanelBtnTexts()
    end
end

-- ========== ç¦ç”¨ Freecam ==========
local function disableFreecam()
    freecamEnabled = false
    camera.CameraType = Enum.CameraType.Custom

    if character then
        if rootPart then
            rootPart.Anchored = false
        end

        local humanoid = character:FindFirstChildOfClass("Humanoid")
        if humanoid then
            humanoid.AutoRotate = true
        end
        camera.CameraSubject = character:FindFirstChildOfClass("Humanoid")
    end

    rootPart = nil
    savedCharacterCFrame = nil

    if toggleBtn then
        toggleBtn.Text = "é–‹å•Ÿ Freecam"
        toggleBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 255)
        if not isMinimized then
            moveFrame.Visible = false
            lookFrame.Visible = false
            speedUpBtn.Visible = false
            speedDownBtn.Visible = false
            speedFrame.Visible = false
        end
    end

    if isPanelOpen then
        updatePanelBtnTexts()
    end
end

-- ========== æ›´æ–°é€Ÿåº¦ ==========
local function updateSpeed()
    moveSpeed = baseSpeed * speedMultiplier
    verticalSpeed = baseVerticalSpeed * speedMultiplier
end

-- ========== é€Ÿåº¦è¼¸å…¥æ¡† ==========
speedInput.FocusLost:Connect(function()
    local value = tonumber(speedInput.Text)
    if value and value >= 0 and value <= 99 then
        speedMultiplier = value
        if speedMultiplier == math.floor(speedMultiplier) then
            speedInput.Text = tostring(math.floor(speedMultiplier))
        else
            speedInput.Text = string.format("%.2f", speedMultiplier)
        end
        updateSpeed()
    else
        if speedMultiplier == math.floor(speedMultiplier) then
            speedInput.Text = tostring(math.floor(speedMultiplier))
        else
            speedInput.Text = string.format("%.2f", speedMultiplier)
        end
    end
end)

speedMinusBtn.MouseButton1Click:Connect(function()
    if speedMultiplier > 0 then
        speedMultiplier = math.max(0, speedMultiplier - 1)
        if speedMultiplier == math.floor(speedMultiplier) then
            speedInput.Text = tostring(math.floor(speedMultiplier))
        else
            speedInput.Text = string.format("%.2f", speedMultiplier)
        end
        updateSpeed()
    end
end)

speedPlusBtn.MouseButton1Click:Connect(function()
    if speedMultiplier < 99 then
        speedMultiplier = math.min(99, speedMultiplier + 1)
        if speedMultiplier == math.floor(speedMultiplier) then
            speedInput.Text = tostring(math.floor(speedMultiplier))
        else
            speedInput.Text = string.format("%.2f", speedMultiplier)
        end
        updateSpeed()
    end
end)

-- ========== ç¸®å°/å±•é–‹ ==========
local function toggleMinimize()
    isMinimized = not isMinimized

    if isMinimized then
        minimizeBtn.Text = "+"
        toggleBtn.Visible = false
        clickTpBtn.Visible = false
        closeBtn.Visible = false
        hintLabel.Visible = false
        speedFrame.Visible = false
        -- å°è—æŒ‰éˆ•ä¸€èµ·éš±è—ï¼ˆå¦‚æœåœ¨ screenGui ä¸Šï¼‰
        if listBtn.Parent == screenGui then
            listBtn.Visible = false
        end
        -- é¢æ¿ä¹Ÿé—œé–‰
        if isPanelOpen then
            closePanel()
        end

        if freecamEnabled then
            moveFrame.Visible = false
            lookFrame.Visible = false
            speedUpBtn.Visible = false
            speedDownBtn.Visible = false
        end
    else
        minimizeBtn.Text = "âˆ’"
        toggleBtn.Visible = true
        clickTpBtn.Visible = true
        closeBtn.Visible = true
        -- å°è—æŒ‰éˆ•ä¸€èµ·é¡¯ç¤º
        if listBtn.Parent == screenGui then
            listBtn.Visible = true
        end

        if freecamEnabled then
            moveFrame.Visible = true
            lookFrame.Visible = true
            speedUpBtn.Visible = true
            speedDownBtn.Visible = true
            speedFrame.Visible = true

            if clickTpEnabled and hintLabel then
                hintLabel.Visible = true
            end
        end
    end
end

-- ========== è§’è‰²æ­»äº¡ç›£è½ ==========
local function onCharacterAdded(newCharacter)
    character = newCharacter

    local humanoid = character:WaitForChild("Humanoid")
    humanoid.Died:Connect(function()
        if freecamEnabled then
            freecamEnabled = false
            camera.CameraType = Enum.CameraType.Custom

            toggleBtn.Text = "é–‹å•Ÿ Freecam"
            toggleBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 255)
            if not isMinimized then
                moveFrame.Visible = false
                lookFrame.Visible = false
                speedUpBtn.Visible = false
                speedDownBtn.Visible = false
                speedFrame.Visible = false
            end

            rootPart = nil
            savedCharacterCFrame = nil

            if isPanelOpen then
                updatePanelBtnTexts()
            end

            print("è§’è‰²æ­»äº¡ï¼ŒFreecam å·²è‡ªå‹•é—œé–‰")
        end
    end)
end

if character then
    onCharacterAdded(character)
end
player.CharacterAdded:Connect(onCharacterAdded)

-- ========== æ‹–æ‹½åŒæ­¥ ==========
local isDragging = false
local dragStartPos = nil
local minimizeDragStart = nil

minimizeBtn.MouseButton1Down:Connect(function()
    minimizeDragStart = minimizeBtn.Position
    isDragging = false
end)

minimizeBtn:GetPropertyChangedSignal("Position"):Connect(function()
    if minimizeDragStart then
        isDragging = true
        local offset = minimizeBtn.Position - minimizeDragStart

        toggleBtn.Position = toggleBtn.Position + offset

        -- åŒæ­¥ listBtn ä½ç½®ï¼ˆç•¶å®ƒåœ¨ screenGui æ™‚ï¼‰
        if listBtn.Parent == screenGui then
            listBtn.Position = listBtn.Position + offset
        end

        -- åŒæ­¥é¢æ¿ä½ç½®ï¼ˆç„¡è«–é¢æ¿æ˜¯å¦é–‹å•Ÿéƒ½è·Ÿè‘—å‹•ï¼‰
        panelFrame.Position = panelFrame.Position + offset

        minimizeDragStart = minimizeBtn.Position
    end
end)

toggleBtn.MouseButton1Down:Connect(function()
    isDragging = false
end)

speedInput.Focused:Connect(function()
    minimizeBtn.Draggable = false
end)

speedInput.FocusLost:Connect(function()
    task.wait(0.1)
    minimizeBtn.Draggable = true
end)

-- ========== è§¸æ§åç§»è¨ˆç®— ==========
local function getTouchOffset(touch, frame)
    local frameCenter = frame.AbsolutePosition + frame.AbsoluteSize / 2
    local touchPos = Vector2.new(touch.Position.X, touch.Position.Y)
    local offset = touchPos - frameCenter
    local maxDist = frame.AbsoluteSize.X / 2
    return offset / maxDist
end

-- ========== è§¸æ§è¼¸å…¥ ==========
UserInputService.TouchStarted:Connect(function(touch, gameProcessed)
    if gameProcessed then return end
    if not freecamEnabled then return end
    if isMinimized then return end

    local touchPos = Vector2.new(touch.Position.X, touch.Position.Y)

    local moveMin = moveFrame.AbsolutePosition
    local moveMax = moveMin + moveFrame.AbsoluteSize
    if touchPos.X >= moveMin.X and touchPos.X <= moveMax.X and
       touchPos.Y >= moveMin.Y and touchPos.Y <= moveMax.Y then
        moveTouch = touch
    end

    local lookMin = lookFrame.AbsolutePosition
    local lookMax = lookMin + lookFrame.AbsoluteSize
    if touchPos.X >= lookMin.X and touchPos.X <= lookMax.X and
       touchPos.Y >= lookMin.Y and touchPos.Y <= lookMax.Y then
        lookTouch = touch
    end
end)

UserInputService.TouchEnded:Connect(function(touch, gameProcessed)
    if moveTouch and touch == moveTouch then
        moveTouch = nil
    end
    if lookTouch and touch == lookTouch then
        lookTouch = nil
    end
end)

-- ========== é«˜åº¦æ§åˆ¶ ==========
speedUpBtn.MouseButton1Down:Connect(function()
    speedTouch = "up"
end)
speedUpBtn.MouseButton1Up:Connect(function()
    if speedTouch == "up" then speedTouch = nil end
end)
speedDownBtn.MouseButton1Down:Connect(function()
    speedTouch = "down"
end)
speedDownBtn.MouseButton1Up:Connect(function()
    if speedTouch == "down" then speedTouch = nil end
end)

-- ========== ç¸®å°æŒ‰éˆ• ==========
minimizeBtn.MouseButton1Click:Connect(function()
    if not isDragging then
        toggleMinimize()
    end
    isDragging = false
    minimizeDragStart = nil
end)

-- ========== åˆ‡æ› Freecam ==========
toggleBtn.MouseButton1Click:Connect(function()
    if not isDragging then
        if freecamEnabled then
            disableFreecam()
            toggleBtn.Text = "é–‹å•Ÿ Freecam"
            toggleBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 255)
            if not isMinimized then
                moveFrame.Visible = false
                lookFrame.Visible = false
                speedUpBtn.Visible = false
                speedDownBtn.Visible = false
                hintLabel.Visible = false
                speedFrame.Visible = false
            end
        else
            enableFreecam()
            toggleBtn.Text = "é—œé–‰ Freecam"
            toggleBtn.BackgroundColor3 = Color3.fromRGB(255, 100, 100)
            if not isMinimized then
                moveFrame.Visible = true
                lookFrame.Visible = true
                speedUpBtn.Visible = true
                speedDownBtn.Visible = true
                speedFrame.Visible = true
                if clickTpEnabled and hintLabel then
                    hintLabel.Visible = true
                end
            end
        end
    end
    isDragging = false
    minimizeDragStart = nil
end)

-- ========== é—œé–‰è…³æœ¬ ==========
closeBtn.MouseButton1Click:Connect(function()
    if freecamEnabled then
        disableFreecam()
    end
    screenGui:Destroy()
    print("Freecam è…³æœ¬å·²é—œé–‰")
end)

-- ========== ClickTP åˆ‡æ› ==========
clickTpBtn.MouseButton1Click:Connect(function()
    clickTpEnabled = not clickTpEnabled
    if clickTpEnabled then
        clickTpBtn.Text = "ClickTP: é–‹"
        clickTpBtn.BackgroundColor3 = Color3.fromRGB(50, 255, 50)
        if freecamEnabled and not isMinimized and hintLabel then
            hintLabel.Visible = true
            task.delay(5, function()
                if hintLabel and hintLabel.Parent then
                    hintLabel.Visible = false
                end
            end)
        end
    else
        clickTpBtn.Text = "ClickTP: é—œ"
        clickTpBtn.BackgroundColor3 = Color3.fromRGB(255, 165, 0)
        if hintLabel then
            hintLabel.Visible = false
        end
    end
end)

-- ========== å°è—æŒ‰éˆ•ï¼ˆæ¸…å–®é¢æ¿ï¼‰==========
listBtn.MouseButton1Click:Connect(function()
    if isPanelOpen then
        closePanel()
    else
        if not isMinimized then
            openPanel()
        end
    end
end)

-- ========== ç©¿é€æ¨¡å¼å‹¾é¸ ==========
throughCheck.MouseButton1Click:Connect(function()
    isThroughMode = not isThroughMode
    updateThroughCheckUI()
    print("ç©¿é€æ¨¡å¼: " .. (isThroughMode and "é–‹å•Ÿ" or "é—œé–‰"))
end)

-- ========== è¨­å®šå‚³é€é»æŒ‰éˆ• ==========
setWaypointBtn.MouseButton1Click:Connect(function()
    waypointCounter = waypointCounter + 1
    local wpName = "å‚³é€é» " .. waypointCounter

    if freecamEnabled then
        -- Freecam æ¨¡å¼ï¼šè¨˜éŒ„é¡é ­çš„ CFrame
        waypointList[#waypointList + 1] = {
            name = wpName,
            position = cameraCFrame.Position,
            cframe = cameraCFrame,
            isCamFrame = true
        }
        print("å·²è¨­å®šé¡é ­å‚³é€é»: " .. wpName)
    else
        -- æ™®é€šæ¨¡å¼ï¼šè¨˜éŒ„è§’è‰²ä½ç½®
        if character then
            local hrp = character:FindFirstChild("HumanoidRootPart")
            if hrp then
                waypointList[#waypointList + 1] = {
                    name = wpName,
                    position = hrp.Position,
                    cframe = hrp.CFrame,
                    isCamFrame = false
                }
                print("å·²è¨­å®šè§’è‰²å‚³é€é»: " .. wpName)
            end
        end
    end

    updateWaypointListUI()
end)

-- ========== å‚³é€åˆ°é¸å®šé»æŒ‰éˆ• ==========
tpToWaypointBtn.MouseButton1Click:Connect(function()
    if not selectedWaypointIndex then
        print("è«‹å…ˆåœ¨æ¸…å–®ä¸­é¸æ“‡ä¸€å€‹å‚³é€é»")
        return
    end

    local wp = waypointList[selectedWaypointIndex]
    if not wp then return end

    if freecamEnabled then
        -- Freecam æ¨¡å¼ï¼šåªç§»å‹•é¡é ­
        cameraCFrame = wp.cframe
        camera.CFrame = cameraCFrame
        print("é¡é ­å·²ç§»å‹•åˆ°: " .. wp.name)
    else
        -- æ™®é€šæ¨¡å¼ï¼šç§»å‹•è§’è‰²
        if character then
            local hrp = character:FindFirstChild("HumanoidRootPart")
            if hrp then
                hrp.CFrame = wp.cframe
                print("è§’è‰²å·²å‚³é€åˆ°: " .. wp.name)
            end
        end
    end
end)

-- ========== ç©¿é€æ¨¡å¼å°„ç·šè¼”åŠ©å‡½æ•¸ ==========
-- ç”¨éè¿´æ–¹å¼å¿½ç•¥é€æ˜ç‰©ä»¶ï¼Œç›´åˆ°æ‰“åˆ°ä¸é€æ˜ç‰©ä»¶
local function raycastThroughTransparent(origin, direction, params, maxBounces)
    maxBounces = maxBounces or 20
    local excludeList = params.FilterDescendantsInstances or {}
    local currentExclude = {}
    for _, v in ipairs(excludeList) do
        table.insert(currentExclude, v)
    end

    for _ = 1, maxBounces do
        local p = RaycastParams.new()
        p.FilterType = Enum.RaycastFilterType.Exclude
        p.FilterDescendantsInstances = currentExclude

        local result = workspace:Raycast(origin, direction, p)
        if not result then break end

        local hit = result.Instance
        -- å–å¾—é€æ˜åº¦ï¼ˆè€ƒæ…®çˆ¶å±¤ Model çš„ LocalTransparencyModifierï¼‰
        local transparency = hit.Transparency
        if hit:IsA("BasePart") and transparency >= 0.9 then
            -- é€æ˜ç‰©ä»¶ï¼šåŠ å…¥æ’é™¤ï¼Œç¹¼çºŒåµæ¸¬
            table.insert(currentExclude, hit)
        else
            -- ä¸é€æ˜ï¼ˆæˆ–åŠé€æ˜ï¼‰ï¼šè¿”å›çµæœ
            return result
        end
    end

    return nil
end

-- ========== ClickTP åŠŸèƒ½ ==========
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if not clickTpEnabled then return end
    if input.UserInputType ~= Enum.UserInputType.MouseButton1 and
       input.UserInputType ~= Enum.UserInputType.Touch then return end

    local touchPos = Vector2.new(input.Position.X, input.Position.Y)

    -- æ’é™¤é¢æ¿å€åŸŸ
    if isPanelOpen and panelFrame.Visible then
        local panMin = panelFrame.AbsolutePosition
        local panMax = panMin + panelFrame.AbsoluteSize
        if touchPos.X >= panMin.X and touchPos.X <= panMax.X and
           touchPos.Y >= panMin.Y and touchPos.Y <= panMax.Y then
            return
        end
    end

    -- æ’é™¤ toggleBtn å€åŸŸ
    if toggleBtn.Visible then
        local toggleMin = toggleBtn.AbsolutePosition
        local toggleMax = toggleMin + toggleBtn.AbsoluteSize + Vector2.new(
            math.max(closeBtn.AbsoluteSize.X, minimizeBtn.AbsoluteSize.X),
            clickTpBtn.AbsoluteSize.Y + closeBtn.AbsoluteSize.Y
        )
        if touchPos.X >= toggleMin.X and touchPos.X <= toggleMax.X and
           touchPos.Y >= toggleMin.Y and touchPos.Y <= toggleMax.Y then
            return
        end
    end

    -- æ’é™¤ minimizeBtn å€åŸŸ
    local minMin = minimizeBtn.AbsolutePosition
    local minMax = minMin + minimizeBtn.AbsoluteSize
    if touchPos.X >= minMin.X and touchPos.X <= minMax.X and
       touchPos.Y >= minMin.Y and touchPos.Y <= minMax.Y then
        return
    end

    -- æ’é™¤ listBtn å€åŸŸï¼ˆç•¶åœ¨ screenGui æ™‚ï¼‰
    if listBtn.Parent == screenGui and listBtn.Visible then
        local listMin = listBtn.AbsolutePosition
        local listMax = listMin + listBtn.AbsoluteSize
        if touchPos.X >= listMin.X and touchPos.X <= listMax.X and
           touchPos.Y >= listMin.Y and touchPos.Y <= listMax.Y then
            return
        end
    end

    if freecamEnabled and not isMinimized then
        local moveMin = moveFrame.AbsolutePosition
        local moveMax = moveMin + moveFrame.AbsoluteSize
        if touchPos.X >= moveMin.X and touchPos.X <= moveMax.X and
           touchPos.Y >= moveMin.Y and touchPos.Y <= moveMax.Y then
            return
        end

        local lookMin = lookFrame.AbsolutePosition
        local lookMax = lookMin + lookFrame.AbsoluteSize
        if touchPos.X >= lookMin.X and touchPos.X <= lookMax.X and
           touchPos.Y >= lookMin.Y and touchPos.Y <= lookMax.Y then
            return
        end

        local upMin = speedUpBtn.AbsolutePosition
        local upMax = upMin + speedUpBtn.AbsoluteSize
        if touchPos.X >= upMin.X and touchPos.X <= upMax.X and
           touchPos.Y >= upMin.Y and touchPos.Y <= upMax.Y then
            return
        end

        local downMin = speedDownBtn.AbsolutePosition
        local downMax = downMin + speedDownBtn.AbsoluteSize
        if touchPos.X >= downMin.X and touchPos.X <= downMax.X and
           touchPos.Y >= downMin.Y and touchPos.Y <= downMax.Y then
            return
        end
    end

    -- åŸ·è¡Œç¬ç§»
    local mouseLocation = UserInputService:GetMouseLocation()
    local unitRay = camera:ViewportPointToRay(mouseLocation.X, mouseLocation.Y)
    local raycastParams = RaycastParams.new()
    raycastParams.FilterType = Enum.RaycastFilterType.Exclude
    raycastParams.FilterDescendantsInstances = {character}

    local raycastResult

    if isThroughMode then
        -- ç©¿é€æ¨¡å¼ï¼šå¿½ç•¥é€æ˜ç‰©ä»¶
        raycastResult = raycastThroughTransparent(
            unitRay.Origin,
            unitRay.Direction * 1000,
            raycastParams
        )
    else
        raycastResult = workspace:Raycast(unitRay.Origin, unitRay.Direction * 1000, raycastParams)
    end

    if raycastResult and character then
        local hrp = character:FindFirstChild("HumanoidRootPart")
        if hrp then
            local targetPos = raycastResult.Position + Vector3.new(0, 3, 0)

            if freecamEnabled then
                hrp.Anchored = false
                hrp.CFrame = CFrame.new(targetPos)
                hrp.AssemblyLinearVelocity = Vector3.new(0, 0, 0)
                hrp.AssemblyAngularVelocity = Vector3.new(0, 0, 0)
                task.wait(0.1)
                hrp.Anchored = true
                savedCharacterCFrame = CFrame.new(targetPos)
                rootPart = hrp
            else
                hrp.CFrame = CFrame.new(targetPos)
            end
        end
    end
end)

-- ========== åˆå§‹éš±è— ==========
moveFrame.Visible = false
lookFrame.Visible = false
speedUpBtn.Visible = false
speedDownBtn.Visible = false

updateThroughCheckUI()

-- ========== ç›¸æ©Ÿæ›´æ–° ==========
RunService.RenderStepped:Connect(function(deltaTime)
    if not freecamEnabled then return end

    if rootPart and savedCharacterCFrame then
        rootPart.CFrame = savedCharacterCFrame
        rootPart.AssemblyLinearVelocity = Vector3.new(0, 0, 0)
        rootPart.AssemblyAngularVelocity = Vector3.new(0, 0, 0)
    end

    local moveVector = Vector3.new(0, 0, 0)

    if moveTouch then
        local offset = getTouchOffset(moveTouch, moveFrame)
        moveVector = Vector3.new(offset.X, 0, -offset.Y)
    end

    if lookTouch then
        local offset = getTouchOffset(lookTouch, lookFrame)
        local rotX = -offset.Y * rotationSpeed * 100 * deltaTime
        local rotY = -offset.X * rotationSpeed * 100 * deltaTime

        cameraCFrame = cameraCFrame * CFrame.Angles(rotX, 0, 0)
        cameraCFrame = CFrame.new(cameraCFrame.Position) * CFrame.Angles(0, rotY, 0) * CFrame.new(0, 0, 0) * (cameraCFrame - cameraCFrame.Position)
    end

    if speedTouch == "up" then
        moveVector = moveVector + Vector3.new(0, verticalSpeed / moveSpeed, 0)
    elseif speedTouch == "down" then
        moveVector = moveVector + Vector3.new(0, -verticalSpeed / moveSpeed, 0)
    end

    if moveVector.Magnitude > 0 then
        local cameraMoveVector = (cameraCFrame.RightVector * moveVector.X +
                                  Vector3.new(0, moveVector.Y, 0) +
                                  cameraCFrame.LookVector * moveVector.Z)
        cameraCFrame = cameraCFrame + (cameraMoveVector * moveSpeed)
    end

    camera.CFrame = cameraCFrame
end)

print("å¹³æ¿ Freecam è…³æœ¬å·²è¼‰å…¥!")
print("é»æ“Šåº•éƒ¨çš„æŒ‰éˆ•ä¾†é–‹å•Ÿ/é—œé–‰ Freecam")
print("å·¦å´æ–æ¡¿: å‰å¾Œå·¦å³ç§»å‹•")
print("å³å´æ–æ¡¿: æ—‹è½‰è¦–è§’")
print("é ‚éƒ¨æŒ‰éˆ•: ä¸Šå‡/ä¸‹é™")
print("âˆ’/+ æŒ‰éˆ•: ç¸®å°/å±•é–‹æ‰€æœ‰æ§åˆ¶æŒ‰éˆ•")
print("â˜° å°è—æŒ‰éˆ•: é–‹å•Ÿå‚³é€é»æ¸…å–®é¢æ¿")
